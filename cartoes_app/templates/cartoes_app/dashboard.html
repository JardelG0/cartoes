{% extends 'cartoes_app/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
{% if request.user.is_staff %}
  <!-- Painel do Administrador -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <h5 class="card-title mb-0">Painel do Administrador</h5>
            <div class="d-flex flex-wrap gap-2">
              <a href="{% url 'criar_cartao' %}" class="btn btn-primary btn-sm">Adicionar Cartão</a>
              {% if perms.auth.add_user %}
                <a href="{% url 'registrar_usuario' %}" class="btn btn-outline-primary btn-sm">Registrar Usuário</a>
              {% endif %}
              <a href="{% url 'usuarios' %}" class="btn btn-outline-success btn-sm">Usuários</a>
              <a href="{% url 'gastos' %}" class="btn btn-outline-warning btn-sm">Gastos</a>
            </div>
          </div>

          <!-- Resumo -->
          <div class="row g-3 mb-4">
            <div class="col-12 col-md-6">
              <div class="border rounded p-3 text-center bg-light h-100">
                <div class="small text-muted">Usuários</div>
                <div class="fs-4 fw-bold">{{ total_usuarios }}</div>
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="border rounded p-3 text-center bg-light h-100">
                <div class="small text-muted">Cartões</div>
                <div class="fs-4 fw-bold">{{ total_cartoes }}</div>
              </div>
            </div>
          </div>

          <!-- Usuários -->
          <h6 class="mb-3">Usuários</h6>
          <div class="row g-3">
            {% for u in usuarios %}
              <div class="col-12">
                <details class="user-block">
                  <summary class="card shadow-sm text-center p-3 mb-2 user-card">
                    <h6 class="card-title mb-1">{{ u.username }}</h6>
                    {% if u.saldo < 0 %}
                      <div class="fs-5 fw-bold text-danger">R$ {{ u.saldo|floatformat:2 }}</div>
                    {% elif u.saldo == 0 %}
                      <div class="fs-5 fw-bold text-warning">R$ {{ u.saldo|floatformat:2 }}</div>
                    {% else %}
                      <div class="fs-5 fw-bold text-success">R$ {{ u.saldo|floatformat:2 }}</div>
                    {% endif %}
                  </summary>

                  <div class="user-cards mt-2">
                    <div class="row">
                      {% for cartao in u.cartoes.all %}
                        <div class="col-md-6 col-lg-4 mb-3">
                          <div class="card shadow-sm h-100 position-relative">
                            <div class="card-body">
                              <h5 class="card-title">{{ cartao.nome }}</h5>
                              <h6 class="card-subtitle text-muted mb-2">{{ cartao.get_bandeira_display }}</h6>
                              <p class="card-text">
                                <strong>Número:</strong> {{ cartao.numero_mascarado }}<br>
                                <strong>Vencimento:</strong> {{ cartao.vencimento_formatado }}<br>
                                <strong>Limite:</strong> R$ {{ cartao.limite|floatformat:2 }}<br>
                                <strong>Saldo atual:</strong> R$ {{ cartao.saldo_atual|floatformat:2 }}
                              </p>
                              <a href="{% url 'editar_cartao' cartao.id %}" class="btn btn-sm btn-outline-primary mt-2">Editar</a>
                              <a href="{% url 'excluir_cartao' cartao.id %}" class="btn btn-sm btn-outline-danger mt-2 ms-2">Excluir</a>
                              <a href="{% url 'recarregar_cartao' cartao.id %}" class="btn btn-sm btn-outline-success mt-2 ms-2">Recarregar</a>
                            </div>
                            <img src="{% static cartao.bandeira_static_filename %}"
                                 alt="{{ cartao.get_bandeira_display }}"
                                 class="bandeira-logo">
                          </div>
                        </div>
                      {% empty %}
                        <div class="col-12">
                          <div class="alert alert-info">Nenhum cartão para este usuário.</div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </details>
              </div>
            {% endfor %}
          </div>

        </div>
      </div>
    </div>
  </div>

  <style>
    summary {
      list-style: none; /* remove seta padrão */
      cursor: pointer;
    }
    summary::-webkit-details-marker {
      display: none; /* remove seta no Chrome/Safari */
    }
    .user-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .bandeira-logo {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 48px;
      height: 48px;
      opacity: 0.2;
      pointer-events: none;
    }
  </style>
{% endif %}
{% endblock %}
