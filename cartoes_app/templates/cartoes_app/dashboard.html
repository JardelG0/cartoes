{# cartoes_app/templates/cartoes_app/dashboard.html #}
{% extends 'cartoes_app/base.html' %}
{% load static %}  {# <- NECESSÁRIO para usar {% static %} aqui #}
{% load humanize %}

{% block title %}Dashboard{% endblock %}

{% block content %}

{# ===== TOPO DO DASHBOARD (reestruturado) ===== #}
<div class="row mb-3">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <h2 class="mb-0">
      {% if request.user.is_staff %}Todos os Cartões{% else %}Meus Cartões{% endif %}
    </h2>

    {% if not request.user.is_staff %}
      <a href="{% url 'gastos' %}" class="btn btn-outline-secondary btn-sm">
        ← Voltar para Gastos
      </a>
    {% endif %}
  </div>
</div>

{# Mensagens locais REMOVIDAS para evitar duplicação; base.html já exibe #}

{% if request.user.is_staff %}
  <!-- ====== Painel do Administrador ====== -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">

          <!-- Cabeçalho do painel + botões -->
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="card-title mb-0">Painel do Administrador</h5>
            <div class="d-flex flex-wrap gap-2">
              <a href="{% url 'criar_cartao' %}" class="btn btn-primary btn-sm">Adicionar Cartão</a>
              {% if perms.auth.add_user %}
                <a href="{% url 'registrar_usuario' %}" class="btn btn-outline-primary btn-sm">Registrar Usuário</a>
              {% endif %}
              <a href="{% url 'usuarios' %}" class="btn btn-outline-success btn-sm">Usuários</a>
              <a href="{% url 'gastos' %}" class="btn btn-outline-warning btn-sm">Gastos</a>
              <a href="/admin/" class="btn btn-outline-dark btn-sm">Django Admin</a>
            </div>
          </div>

          <!-- Mini cards de resumo -->
          <div class="row g-3 mt-3 mb-3">
            <div class="col-12 col-md-4">
              <div class="border rounded p-3 text-center bg-light h-100">
                <div class="small text-muted">Usuários</div>
                <div class="fs-4 fw-bold">{{ total_usuarios }}</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="border rounded p-3 text-center bg-light h-100">
                <div class="small text-muted">Cartões</div>
                <div class="fs-4 fw-bold">{{ total_cartoes }}</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="border rounded p-3 text-center bg-light h-100">
                <div class="small text-muted">Limite total</div>
                <div class="fs-6 fw-bold">R$ {{ limite_total|floatformat:2|intcomma }}</div>
              </div>
            </div>
          </div>

          <!-- Filtro de período -->
          <form method="get" class="row g-2 align-items-end mb-3">
            <div class="col-auto">
              <label for="periodo" class="form-label mb-0">Período</label>
              <select id="periodo" name="periodo" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="mes_atual" {% if periodo == 'mes_atual' %}selected{% endif %}>Mês atual</option>
                <option value="ult_30" {% if periodo == 'ult_30' %}selected{% endif %}>Últimos 30 dias</option>
                <option value="todos" {% if periodo == 'todos' %}selected{% endif %}>Todos</option>
              </select>
            </div>
            {% if periodo_inicio and periodo_fim %}
              <div class="col-auto">
                <span class="text-muted small">De {{ periodo_inicio }} a {{ periodo_fim }}</span>
              </div>
            {% endif %}
          </form>

          <!-- Resumo por usuário -->
          <div class="mb-3">
            <h6 class="mb-2">Gastos por usuário</h6>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th>Usuário</th>
                    <th class="text-end">Total gasto (R$)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for u in usuarios_resumo %}
                    <tr>
                      <td>{{ u.username }}</td>
                      <td class="text-end">{{ u.gasto_total|default:0|floatformat:2|intcomma }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="2" class="text-muted">Sem dados.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Resumo por cartão -->
          <div>
            <h6 class="mb-2">Gastos por cartão</h6>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th>Usuário</th>
                    <th>Cartão</th>
                    <th class="text-end">Gasto (R$)</th>
                    <th class="text-end">Limite (R$)</th>
                    <th class="text-end">Saldo restante (R$)</th>
                    <th class="text-end">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for c in cartoes_resumo %}
                    {% with gasto=c.gasto_total|default:0 %}
                    <tr class="{% if c.id in cartoes_alerta %}table-danger{% endif %}">
                      <td>{{ c.usuario.username }}</td>
                      <td>{{ c.nome }}</td>
                      <td class="text-end">{{ gasto|floatformat:2|intcomma }}</td>
                      <td class="text-end">{{ c.limite|floatformat:2|intcomma }}</td>
                      <td class="text-end">
                        {% if c.saldo_restante < 0 %}
                          <span class="text-danger">{{ c.saldo_restante|floatformat:2|intcomma }}</span>
                        {% elif c.saldo_restante == 0 %}
                          <span class="text-warning">{{ c.saldo_restante|floatformat:2|intcomma }}</span>
                        {% else %}
                          <span class="text-success">{{ c.saldo_restante|floatformat:2|intcomma }}</span>
                        {% endif %}
                      </td>
                      <td class="text-end">
                        {% if c.id in cartoes_alerta %}
                          <span class="badge bg-danger">Acima do limite</span>
                        {% else %}
                          <span class="badge bg-success">Ok</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endwith %}
                  {% empty %}
                    <tr><td colspan="6" class="text-muted">Sem dados.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  <!-- ====== /Painel do Administrador ====== -->
{% endif %}
{# ===== /TOPO DO DASHBOARD ===== #}

<!-- Lista de cartões -->
<div class="row">
  {% if cartoes %}
    {% for cartao in cartoes %} 
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-sm h-100 position-relative">
          <div class="card-body">
            <h5 class="card-title">{{ cartao.nome }}</h5>
            <h6 class="card-subtitle text-muted mb-2">{{ cartao.get_bandeira_display }}</h6>
            <p class="card-text">
              {% if request.user.is_staff %}
                <strong>Usuário:</strong> {{ cartao.usuario.username }}<br>
              {% endif %}
              <strong>Número:</strong> {{ cartao.numero_mascarado }}<br>
              <strong>Vencimento:</strong> {{ cartao.vencimento_formatado }}<br>
              <strong>Limite:</strong> R$ {{ cartao.limite|floatformat:2|intcomma }}
            </p>

            {% if request.user.is_staff %}
              <a href="{% url 'editar_cartao' cartao.id %}" class="btn btn-sm btn-outline-primary mt-2">Editar</a>
              <a href="{% url 'excluir_cartao' cartao.id %}" class="btn btn-sm btn-outline-danger mt-2 ms-2">Excluir</a>
            {% endif %}
          </div>

          <!-- Logo da bandeira no canto inferior direito -->
          <img
            src="{% static cartao.bandeira_static_filename %}"
            alt="{{ cartao.get_bandeira_display }}"
            class="bandeira-logo"
          >
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="col-12">
      <div class="alert alert-info">Nenhum cartão cadastrado ainda.</div>
    </div>
  {% endif %}
</div>

<style>
  .bandeira-logo {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 64px;
    height: 64px;
    opacity: 0.2;
    pointer-events: none;
  }
</style>

{% endblock %}
